version: 2
shell: bash
deploy:
  steps:
    terraformPlan:
      before:
        - name: Import - Generate tofu config
          run: |
            set -e
            tofu plan -generate-config-out=${ENV0_ROOT_DIR}/generated.tf
            if [ -e ${ENV0_ROOT_DIR}/generated.tf ]; then
              echo "Found imported resources" >> $ENV0_STEP_SUMMARY
              echo '### Generated tofu config' > $ENV0_STEP_CONTENT
              echo '' > $ENV0_STEP_CONTENT
              echo '```hcl' >> $ENV0_STEP_CONTENT
              cat ${ENV0_ROOT_DIR}/generated.tf >> $ENV0_STEP_CONTENT
              echo '```' >> $ENV0_STEP_CONTENT
              exit 1
            else
              echo "No import operations" >> $ENV0_STEP_SUMMARY
            fi

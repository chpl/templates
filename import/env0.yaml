version: 2
shell: bash
deploy:
  steps:
    terraformPlan:
      after:
        - name: Import - Generate tofu config
          run: |
            set -e
            if grep -q "importing" ${ENV0_TF_PLAN_JSON}; then
              echo "Found imported resources" >> $ENV0_STEP_SUMMARY
              tofu plan -generate-config-out ${ENV0_ROOT_DIR}/generated.tf
              ls -la ${ENV0_ROOT_DIR}/
              echo '### Generated tofu config' > $ENV0_STEP_CONTENT
              echo '' > $ENV0_STEP_CONTENT
              echo '```hcl' >> $ENV0_STEP_CONTENT
              cat ${ENV0_ROOT_DIR}/generated.tf >> $ENV0_STEP_CONTENT
              echo '```' >> $ENV0_STEP_CONTENT
              exit 1
            else
              echo "No import operations found" >> $ENV0_STEP_SUMMARY
            fi
